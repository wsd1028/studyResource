<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <title>图片</title>
    <style>
      #test {
        overflow: auto !important;
        width: 3000px !important;
      }
    </style>
  </head>
  <body>
    <div id="main">
      <div id="test" style="height: 500px"></div>
    </div>
  </body>
  <script src="./echarts.min.js"></script>
  <script src="./vue.js"></script>
  <script src="./element.js"></script>
  <script src="./moment.js"></script>
  <script>
    var v = new Vue({
      el: "#main",
      data: {
        mainLoading: false,
        routeNodes: [],
        routeLines: []
      },
      methods: {
        routeData: function() {
          let that = this;
          let obj = {
            code: 100,
            desc: "OK",
            content: [
              {
                gtime: 1566799699,
                lossed: 0,
                route: [
                  {
                    address: "192.168.3.5",
                    host: "",
                    rtt: [-1, -1, -1],
                    status: -1,
                    ttl: 1
                  },
                  {
                    address: "",
                    host: "",
                    rtt: [-1, -1, -1],
                    status: -1,
                    ttl: 2
                  },
                  {
                    address: "",
                    host: "",
                    rtt: [-1, -1, -1],
                    status: -1,
                    ttl: 3
                  },
                  {
                    address: "36.158.194.113",
                    host: "",
                    rtt: [7, 4, 3],
                    status: 11013,
                    ttl: 4
                  },
                  {
                    address: "36.158.194.121",
                    host: "",
                    rtt: [2, 1, 1],
                    status: 11013,
                    ttl: 5
                  },
                  {
                    address: "36.158.193.5",
                    host: "",
                    rtt: [1, 1, 1],
                    status: 11013,
                    ttl: 6
                  },
                  {
                    address: "",
                    host: "",
                    rtt: [-1, -1, -1],
                    status: -1,
                    ttl: 7
                  },
                  {
                    address: "221.183.19.185",
                    host: "",
                    rtt: [5, 5, 7],
                    status: 11013,
                    ttl: 8
                  },
                  {
                    address: "",
                    host: "",
                    rtt: [-1, -1, -1],
                    status: -1,
                    ttl: 9
                  },
                  {
                    address: "221.176.27.9",
                    host: "",
                    rtt: [62, 56, 70],
                    status: 11013,
                    ttl: 10
                  },
                  {
                    address: "221.176.20.150",
                    host: "",
                    rtt: [35, 34, 34],
                    status: 11013,
                    ttl: 11
                  },
                  {
                    address: "221.183.66.62",
                    host: "",
                    rtt: [-1, -1, 35],
                    status: 11013,
                    ttl: 12
                  },
                  {
                    address: "202.97.95.65",
                    host: "",
                    rtt: [-1, 33, -1],
                    status: 11013,
                    ttl: 13
                  },
                  {
                    address: "",
                    host: "",
                    rtt: [-1, -1, -1],
                    status: -1,
                    ttl: 14
                  },
                  {
                    address: "61.139.113.588",
                    host: "",
                    rtt: [35, 121, 34],
                    status: 11013,
                    ttl: 15
                  },
                  {
                    address: "61.139.2.69",
                    host: "",
                    rtt: [37, 36, 36],
                    status: 0,
                    ttl: 16
                  }
                ],
                site: "61.139.2.69",
                size: 64,
                status: 0,
                time: 34,
                ttl: 16
              },
              {
                gtime: 1566799704,
                lossed: 0,
                route: [
                  {
                    address: "36.158.94.13",
                    host: "",
                    rtt: [-1, -1, -1],
                    status: -1,
                    ttl: 1
                  },
                  {
                    address: "",
                    host: "",
                    rtt: [-1, -1, -1],
                    status: -1,
                    ttl: 2
                  },
                  {
                    address: "",
                    host: "",
                    rtt: [-1, -1, -1],
                    status: -1,
                    ttl: 3
                  },
                  {
                    address: "36.158.94.113",
                    host: "",
                    rtt: [7, 4, 3],
                    status: 11013,
                    ttl: 4
                  },
                  {
                    address: "36.158.194.121",
                    host: "",
                    rtt: [2, 1, 1],
                    status: 11013,
                    ttl: 5
                  },
                  {
                    address: "36.158.13.5",
                    host: "",
                    rtt: [1, 1, 1],
                    status: 11013,
                    ttl: 6
                  },
                  {
                    address: "",
                    host: "",
                    rtt: [-1, -1, -1],
                    status: -1,
                    ttl: 7
                  },
                  {
                    address: "",
                    host: "",
                    rtt: [5, 5, 7],
                    status: 11013,
                    ttl: 8
                  },
                  {
                    address: "",
                    host: "",
                    rtt: [-1, -1, -1],
                    status: -1,
                    ttl: 9
                  },
                  {
                    address: "221.16.27.9",
                    host: "",
                    rtt: [62, 56, 70],
                    status: 11013,
                    ttl: 10
                  },
                  {
                    address: "221.176.20.150",
                    host: "",
                    rtt: [35, 34, 34],
                    status: 11013,
                    ttl: 11
                  },
                  {
                    address: "221.183.66.62",
                    host: "",
                    rtt: [-1, -1, 35],
                    status: 11013,
                    ttl: 12
                  },
                  {
                    address: "202.9.95.65",
                    host: "",
                    rtt: [-1, 33, -1],
                    status: 11013,
                    ttl: 13
                  },
                  {
                    address: "",
                    host: "",
                    rtt: [-1, -1, -1],
                    status: -1,
                    ttl: 14
                  }
                ],
                site: "61.139.2.69",
                size: 64,
                status: 0,
                time: 33,
                ttl: 16
              }
            ]
          };

          function singleArrObj(oldArr, rule) {
            let newArr = [];
            for (var i = 0; i < oldArr.length; i++) {
              var flag = true;
              for (var j = 0; j < newArr.length; j++) {
                let oldItem = oldArr[i];
                let newItem = newArr[j];
                if (oldItem[rule] == newItem[rule]) {
                  flag = false;
                }
              }
              if (flag) {
                newArr.push(oldArr[i]);
              }
            }
            return newArr;
          }

          function makeData() {
            let data = [];
            let mainData = [];
            //为每一个路由增加时间字段(新增)
            for (let i = 0; i < obj.content.length; i++) {
              for (let j = 0; j < obj.content[i].route.length; j++) {
                obj.content[i].route[j].gtime = moment(
                  obj.content[i].gtime
                ).format("YYYY/MM/DD HH:mm:ss");
              }
            }

            //取出所有路由信息将其变为二维数组
            for (let i = 0; i < obj.content.length; i++) {
              data.push(obj.content[i].route);
            }
            //获取多少跳
            let count = data[0].length;
            //将路由分组并初次过滤 空address
            for (let i = 0; i < count; i++) {
              let arr = [];
              for (let j = 0; j < data.length; j++) {
                if (data[j][i]) {
                  if (data[j][i].address) {
                    arr.push(data[j][i]);
                  }
                }
              }
              mainData.push(arr);
            }

            //去空数组项
            let newMainData = [];
            for (let i = 0; i < mainData.length; i++) {
              if (mainData[i].length > 0) {
                newMainData.push(mainData[i]);
              }
            }
            //详细信息(新增)
            let routeDetailData = [];
            for (let i = 0; i < newMainData.length; i++) {
              for (let j = 0; j < newMainData[i].length; j++) {
                routeDetailData.push(newMainData[i][j]);
              }
            }
            //单一信息(新增)
            let routeSingleData=[];

            //去除相同address
            for (let i = 0; i < newMainData.length; i++) {
              newMainData[i] = singleArrObj(newMainData[i], "address");
            }
            let row = 30;
            let cole = 20;
            let rectX = 80;
            let rectY = 25;
            let showNodes = [];
            let lines = [];
            //生成节点
            for (let i = 0; i < newMainData.length; i++) {
              for (let j = 0; j < newMainData[i].length; j++) {
                let nodeObj = {};
                nodeObj.name = newMainData[i][j].address;
                nodeObj.symbol = "rect";
                nodeObj.symbolSize = [rectX, rectY];
                nodeObj.value = [];
                nodeObj.value[0] = (rectX + row) * (i + 1) + rectX;
                nodeObj.detail = newMainData[i][j];
                if (j == 0) {
                  nodeObj.value[1] = 300;
                } else {
                  if (j % 2 > 0) {
                    nodeObj.value[1] = 300 - ((j + 1) / 2) * (cole + rectY);
                  } else {
                    nodeObj.value[1] = 300 + (j / 2) * (cole + rectY);
                  }
                }
                newMainData[i][j].location = nodeObj.value;
                showNodes.push(nodeObj);
              }
            }
            showNodes.splice(0, 0, {
              name: "开始",
              symbol: "rect",
              symbolSize: [rectX, rectY],
              value: [rectX, 300]
            });
            showNodes.splice(showNodes.length, 1, {
              name: "结束",
              symbol: "rect",
              symbolSize: [rectX, rectY],
              value: [(rectX + row) * (newMainData.length + 1) + rectX, 300]
            });
            // 生成线条
            for (let i = 0; i < newMainData.length - 1; i++) {
              for (let m = 0; m < newMainData[i].length; m++) {
                for (let n = 0; n < newMainData[i + 1].length; n++) {
                  let lineObj = {};
                  lineObj.fromName = newMainData[i][m];
                  lineObj.toName = newMainData[i + 1][n];
                  lineObj.coords = [
                    newMainData[i][m].location,
                    newMainData[i + 1][n].location
                  ];
                  lines.push(lineObj);
                }
              }
            }

            //生成开始线条
            for (let i = 0; i < newMainData[0].length; i++) {
              let lineObj = {};
              lineObj.coords = [showNodes[0].value, newMainData[0][i].location];
              lines.push(lineObj);
            }
            //生成结束线条
            for (
              let i = 0;
              i < newMainData[newMainData.length - 1].length;
              i++
            ) {
              let lineObj = {};
              lineObj.coords = [
                newMainData[newMainData.length - 1][i].location,
                showNodes[showNodes.length - 1].value
              ];
              lines.push(lineObj);
            }
            that.routeNodes = showNodes;
            that.routeLines = lines;
          }
          makeData();
        },
        drawChart: function(id) {
          let that = this;
          var myChart = echarts.init(document.getElementById(id));
          var allData = {
            citys: that.routeNodes,
            moveLines: that.routeLines
          };

          option = {
            tooltip: {
              trigger: "item",
              show: true,
              formatter: function(params, ticket, callback) {
                if (params.componentSubType === "scatter") {
                  return params.name + "的表信息，巴拉巴拉~~";
                } else if (params.componentSubType === "lines") {
                  return (
                    "从" + params.data.fromName + "到" + params.data.toName
                  );
                }
              }
            },
            geo: {
              map: "北京市",
              label: {
                emphasis: {
                  show: false
                }
              },
              roam: true,
              itemStyle: {
                normal: {
                  areaColor: "#323c48",
                  borderColor: "#404a59"
                },
                emphasis: {
                  areaColor: "#2a333d"
                }
              }
            },
            series: [
              {
                name: "数据库表",
                type: "scatter",
                coordinateSystem: "geo",
                zlevel: 2,
                rippleEffect: {
                  brushType: "stroke",
                  period: 7,
                  scale: 26
                },
                label: {
                  normal: {
                    show: true,
                    formatter: "{b}",
                    color: "#000"
                  },
                  emphasis: {
                    show: true,
                    formatter: "{b}"
                  }
                },
                symbolSize: 2,
                showEffectOn: "render",
                itemStyle: {
                  normal: {
                    color: function(item) {
                      return "rgba(55,155,255,0.5)";
                    }
                  }
                },
                data: allData.citys
              },
              {
                name: "线路",
                type: "lines",
                coordinateSystem: "geo",
                zlevel: 2,
                large: true,
                effect: {
                  show: true,
                  constantSpeed: 30,
                  symbol: "arrow", //ECharts 提供的标记类型包括 'circle', 'rect', 'roundRect', 'triangle', 'diamond', 'pin', 'arrow'
                  symbolSize: 6,
                  trailLength: 0
                },

                lineStyle: {
                  normal: {
                    color: function(lineItem) {
                      return "rgba(55,155,255,0.5)";
                    },
                    width: 2,
                    opacity: 0.6,
                    curveness: 0.2 //线条弧度
                  }
                },
                data: allData.moveLines
              }
            ]
          };
          myChart.setOption(option);
        }
      },
      mounted: function() {
        this.routeData();
        this.drawChart("test");
      }
    });
  </script>
</html>
