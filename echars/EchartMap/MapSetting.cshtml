
@{
    Layout = null;
}

<!DOCTYPE html>

<html>
<head>
    <meta name="viewport" content="width=device-width" />
    <title>MapSetting</title>
    <link href="~/lib/element/css/index.css" rel="stylesheet" />
    <script src="~/lib/jquery/dist/jquery.js"></script>
    <script src="~/lib/vue/vue.js"></script>
    <script src="~/lib/element/js/index.js"></script>
    <script type="text/javascript" src="https://webapi.amap.com/maps?v=1.4.13&key=dfa7b465b39ba6e69490c20831d38185"></script>
    <style>
        #maps { width: 100%; height: 500px; }
    </style>
    <script>
        function main() {

            var vueRoot = new Vue({
                el: '#app',
                data: {
                    tableData: [],
                    dialogFormVisible: false,
                    loading: true,
                    key: 'dfa7b465b39ba6e69490c20831d38185',
                    lng: 0.0,
                    lat: 0.0,
                    address: '',
                    geocoder: null,
                    map: null,
                    selectRow: null,
                    cools:''
                },
                watch: {
                    dialogFormVisible: function (val) {
                        var _this = this;
                        if (val) {
                            _this.loading = true;
                            var timer = setTimeout(function () {

                                _this.drawMap();
                                _this.loading = false;
                                clearTimeout(timer);
                            }, 500)
                        }
                    }
                },
                methods: {
                    showDialog: function (row) {
                        this.dialogFormVisible = true;
                        this.selectRow = row;
                    },
                    closeDialog: function () {
                        this.dialogFormVisible = false;
                        this.selectRow = null;
                        this.address = '';
                        this.lng = 0.0;
                        this.lat = 0.0;
                        this.geocoder = null;
                        this.map = null;
                    },
                    getTableData: function () {
                        var _this = this;
                        $.get('/lib/dataJson/GetNodes.json', function (nodesJson) {
                            _this.tableData = nodesJson;
                        });
                    },
                    drawMap: function () {
                        var _this = this;
                        _this.map = new AMap.Map('maps', {
                            zoom: 7,//级别
                            center: [104.065735, 30.659462]//中心  1·点坐标
                        });
                        _this.map.on('click', function (e) {
                            _this.lng = e.lnglat.lng;
                            _this.lat = e.lnglat.lat;
                            var lnglatXY = [_this.lng, _this.lat];
                            _this.myMapViewLocation(lnglatXY);
                            AMap.service('AMap.Geocoder', function () {
                                _this.geocoder = _this.geocoder == null ? new AMap.Geocoder({}) : _this.geocoder;
                                _this.geocoder.getAddress(lnglatXY, function (status, result) {
                                    if (status === 'complete' && result.info === 'OK') {
                                        _this.address = result.regeocode.formattedAddress;
                                    }
                                });
                            });
                        })
                        _this.map.on('mousemove', function (e) {
                            _this.cools += '[' + e.lnglat.getLng() + ',' + e.lnglat.getLat() + ' ],';
                            console.log(_this.cools);
                        })  
                    },
                    myMapViewLocation: function (lnglatXY) {
                        var _this = this;

                        if (lnglatXY[0] && lnglatXY[1]) {
                            _this.addMarker(lnglatXY);
                        }
                    },
                    addMarker: function (lnglatXY) {
                        var _this = this;
                        var marker = new AMap.Marker({
                            icon: "http://webapi.amap.com/theme/v1.3/markers/n/mark_b.png",
                            position: lnglatXY
                        });
                        _this.map.clearMap();
                        marker.setMap(_this.map);
                        _this.map.setFitView();// 执行定位
                    },
                    mapSearch: function () {
                        var _this = this;
                        AMap.service('AMap.Geocoder', function () {
                            _this.geocoder = _this.geocoder == null ? new AMap.Geocoder({}) : _this.geocoder;
                            _this.geocoder.getLocation(_this.address, function (status, result) {
                                if (status === 'complete' && result.geocodes.length) {
                                    var lnglat = result.geocodes[0].location;
                                    _this.lng = lnglat.lng;
                                    _this.lat = lnglat.lat;
                                    _this.myMapViewLocation([_this.lng, _this.lat]);
                                } else {
                                    Message.error("查询失败")
                                }
                            });
                        });
                    },
                    savePosition: function () {
                        var _this = this;
                        var row = _this.selectRow;
                        if (_this.lng && _this.lat) {
                            //$.get('/EchartMap/')
                            $.ajax({
                                data: {
                                    "nodeName": row.nodeName,
                                    "nodeId": row.nodeId,
                                    "parent": row.parent,
                                    "latitude": _this.lat,
                                    "longitude": _this.lng
                                },
                                type: 'post',
                                url: 'http://10.143.132.125:38001/resource/complexview/UpdateNode',
                                success: function (res) {
                                    if (res) {
                                        Message.success("保存成功")
                                        _this.dialogFormVisible = false;
                                        _this.selectRow = null;
                                        _this.address = '';
                                        _this.lng = 0.0;
                                        _this.lat = 0.0;
                                        _this.geocoder = null;
                                        _this.map = null;
                                        _this.getTableData();
                                    } else {
                                        Message.error("保存失败")
                                    }
                                },
                                error: function (message) {
                                    Message.error("保存失败")
                                }
                            })
                        } else {
                            Message.warning("经纬度不能为空")
                        }
                    }
                },
                mounted: function () {
                    this.getTableData();
                }
            });
        }
        $(function () {
            main();
        })
    </script>
</head>
<body>
    <el-container id="app">
        <el-main>
            <el-table :data="tableData">
                <el-table-column prop="nodeName" label="节点名称">
                </el-table-column>
                <el-table-column prop="nodeId" label="节点ID">
                </el-table-column>
                <el-table-column prop="parent" label="父级">
                </el-table-column>
                <el-table-column prop="latitude" label="纬度">
                </el-table-column>
                <el-table-column prop="longitude" label="经度">
                </el-table-column>
                <el-table-column fixed="right" label="操作">
                    <template slot-scope="scope">
                        <el-button @@click="showDialog(scope.row)" type="text" size="small">设置坐标</el-button>
                    </template>
                </el-table-column>
            </el-table>
            <el-dialog title="数据中心坐标获取" :visible.sync="dialogFormVisible">
                <div id="maps" v-loading="loading"></div>
                <div slot="footer" class="dialog-footer">
                    <el-input placeholder="经度"
                              v-model="lng">
                    </el-input>
                    <el-input placeholder="纬度"
                              v-model="lat">
                    </el-input>
                    <el-input placeholder="地址"
                              v-model="address">
                    </el-input>
                    <el-button @@click="mapSearch">查 询</el-button>
                    <el-button @@click="closeDialog">取 消</el-button>
                    <el-button type="primary" @@click="savePosition">确 定</el-button>
                </div>
            </el-dialog>
        </el-main>
    </el-container>
    <style>
        .el-header { background-color: #B3C0D1; color: #333; line-height: 10px; }
        .el-dialog { width: 80%; height: 80%; margin: 0 auto }
        .el-aside { color: #333; }
        .el-header, .el-footer { background-color: #B3C0D1; color: #333; text-align: center; line-height: 10px; }
        .el-input { width: 250px !important; float: left; margin-left: 50px }
            .el-input input { width: 250px !important; float: left }
        .el-main { background-color: #E9EEF3; color: #333; text-align: center; line-height: 10px; }
        /*.el-button  { width: 250px !important; float: left }*/
        .el-button button { float: left }
    </style>
</body>
</html>
